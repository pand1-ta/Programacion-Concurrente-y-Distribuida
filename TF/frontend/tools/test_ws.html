<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WS Test - Recommender</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; background:#f5f5f5; }
    label { display:block; margin-top:8px; }
    input { padding:6px; margin-left:8px; }
    #log { white-space: pre-wrap; background:#111; color:#0f0; padding:12px; height:300px; overflow:auto; margin-top:12px; }
    button { margin-top:8px; }
  </style>
</head>
<body>
  <h2>Probar WebSocket /ws/recommend</h2>

  <label>
    Host (incluye protocolo http:// o https://):
    <input id="host" value="http://localhost:8080" size="30" />
  </label>

  <label>
    User ID:
    <input id="userid" value="1" />
  </label>

  <label>
    Género:
    <input id="genre" value="animation" />
  </label>

  <label>
    Límite:
    <input id="limit" value="10" type="number" />
  </label>

  <div>
    <button id="connect">Conectar</button>
    <button id="disconnect" disabled>Desconectar</button>
  </div>

  <div id="info" style="margin-top:8px;color:#333"></div>
  <div id="log"></div>

  <script>
    let ws = null
    const logEl = document.getElementById('log')
    const info = document.getElementById('info')

    function writeLog(...args) {
      const t = new Date().toISOString()
      logEl.textContent = t + '  ' + args.join(' ') + '\n' + logEl.textContent
    }

    function buildWsUrl() {
      const rawHost = document.getElementById('host').value.trim()
      const userId = encodeURIComponent(document.getElementById('userid').value.trim() || '1')
      const genre = encodeURIComponent(document.getElementById('genre').value.trim() || '')
      const limit = encodeURIComponent(document.getElementById('limit').value.trim() || '10')

      // Determine ws/wss from host protocol
      let protocol = 'ws'
      let host = rawHost
      if (rawHost.startsWith('https://')) {
        protocol = 'wss'
        host = rawHost.replace(/^https?:\/\//, '')
      } else if (rawHost.startsWith('http://')) {
        protocol = 'ws'
        host = rawHost.replace(/^https?:\/\//, '')
      } else if (rawHost.startsWith('ws://') || rawHost.startsWith('wss://')) {
        // allow specifying ws://host:port directly
        return rawHost + '/ws/recommend/' + userId + '?genre=' + genre + '&limit=' + limit
      } else {
        // assume http
        host = rawHost
      }

      return protocol + '://' + host + '/ws/recommend/' + userId + '?genre=' + genre + '&limit=' + limit
    }

    document.getElementById('connect').addEventListener('click', () => {
      if (ws) {
        writeLog('Ya conectado. Desconecta primero.')
        return
      }
      const url = buildWsUrl()
      info.textContent = 'Conectando a: ' + url
      writeLog('Intentando conectar:', url)

      try {
        ws = new WebSocket(url)
      } catch (err) {
        writeLog('Error creando WebSocket:', err)
        ws = null
        return
      }

      ws.addEventListener('open', () => {
        writeLog('OPEN')
        document.getElementById('connect').disabled = true
        document.getElementById('disconnect').disabled = false
      })

      ws.addEventListener('message', (ev) => {
        writeLog('MESSAGE:', ev.data)
      })

      ws.addEventListener('close', (ev) => {
        writeLog('CLOSE code=' + (ev && ev.code) + ' reason=' + (ev && ev.reason))
        ws = null
        document.getElementById('connect').disabled = false
        document.getElementById('disconnect').disabled = true
      })

      ws.addEventListener('error', (ev) => {
        writeLog('ERROR', ev && ev.message ? ev.message : JSON.stringify(ev))
      })
    })

    document.getElementById('disconnect').addEventListener('click', () => {
      if (!ws) return
      writeLog('Cerrando socket...')
      ws.close()
    })
  </script>
</body>
</html>
